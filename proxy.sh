#!/bin/bash

# Colors for better display
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

clear

# S2codetaem Logo và giới thiệu
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║${WHITE}                                                                               ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}     ${RED}██████${YELLOW}██████${WHITE}       ${GREEN}██████${BLUE}██████${PURPLE}██████${WHITE}  ${CYAN}████████${RED}███████${WHITE}     ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}    ${RED}██${WHITE}    ${YELLOW}██${WHITE}              ${GREEN}██${WHITE}     ${BLUE}██${WHITE}     ${PURPLE}██${WHITE}  ${CYAN}██${WHITE}       ${RED}██${WHITE}      ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}    ${RED}██████${YELLOW}██████${WHITE}            ${GREEN}██${WHITE}     ${BLUE}██${WHITE}     ${PURPLE}██${WHITE}  ${CYAN}████████${RED}███████${WHITE}     ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}          ${YELLOW}██${WHITE}              ${GREEN}██${WHITE}     ${BLUE}██${WHITE}     ${PURPLE}██${WHITE}  ${CYAN}██${WHITE}            ${RED}██${WHITE} ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}    ${RED}██████${YELLOW}██████${WHITE}        ${GREEN}██████${BLUE}██████${PURPLE}██████${WHITE}  ${CYAN}████████${RED}███████${WHITE}     ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}                                                                               ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}    ▄${RED}▄${WHITE}▄▄▄▄  ${YELLOW}▄${GREEN}▄${WHITE}▄▄▄▄      ${BLUE}▄${PURPLE}▄${WHITE}▄▄▄▄  ${CYAN}▄${RED}▄${WHITE}▄▄▄▄  ${YELLOW}▄${GREEN}▄${WHITE}▄▄▄▄  ${BLUE}▄${PURPLE}▄${WHITE}▄▄▄▄    ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}   ${RED}██${WHITE}▀▀▀▀   ${YELLOW}██${GREEN}█${WHITE}▀▀▀▀     ${BLUE}██${PURPLE}█${WHITE}▀▀▀▀  ${CYAN}██${RED}█${WHITE}▀▀▀▀  ${YELLOW}██${GREEN}█${WHITE}▀▀▀▀  ${BLUE}██${PURPLE}█${WHITE}▀▀▀▀   ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}   ${RED}████${WHITE}▄▄   ${YELLOW}██${GREEN}██${WHITE}▄▄▄      ${BLUE}██${PURPLE}██${WHITE}▄▄▄  ${CYAN}██${RED}██${WHITE}▄▄▄  ${YELLOW}██${GREEN}██${WHITE}▄▄▄  ${BLUE}██${PURPLE}██${WHITE}▄▄▄   ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}      ${RED}███${WHITE}  ${YELLOW}██${GREEN}███${WHITE}       ${BLUE}██${PURPLE}███${WHITE}    ${CYAN}██${RED}███${WHITE}    ${YELLOW}██${GREEN}███${WHITE}    ${BLUE}██${PURPLE}███${WHITE}    ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}   ${RED}██████${WHITE}  ${YELLOW}██${GREEN}████${WHITE}▄▄▄   ${BLUE}██${PURPLE}████${WHITE}▄▄ ${CYAN}██${RED}████${WHITE}▄▄ ${YELLOW}██${GREEN}████${WHITE}▄▄ ${BLUE}██${PURPLE}████${WHITE}▄▄  ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}                                                                               ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}                     ⚡${YELLOW} S2CODE TEAM ${RED}★ ${BLUE}PROXY INSTALLER ${WHITE}⚡                      ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}                   ${GREEN}🚀 Premium Tools & Services Provider 🚀                  ${CYAN}║${NC}"
echo -e "${CYAN}║${WHITE}                                                                               ${CYAN}║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Thông tin nhà phát triển
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${WHITE}                              THÔNG TIN NHÀ PHÁT TRIỂN                        ${GREEN}║${NC}"
echo -e "${GREEN}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${GREEN}║${YELLOW} 👨‍💻 Nhà phát triển: ${WHITE}TẠ NGỌC LONG                                           ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 🌐 Chuyên cung cấp tài khoản Google Cloud số lượng lớn                     ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 🎮 Chuyên cung cấp các mặt hàng MMO                                        ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 🔗 Chuyên cung cấp tài nguyên Proxy, tài khoản các loại                    ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 💻 Nhận tạo Tools, tạo Web, code phần mềm theo nhu cầu                     ${GREEN}║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Thông tin liên hệ
echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║${WHITE}                                LIÊN HỆ                                      ${BLUE}║${NC}"
echo -e "${BLUE}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${BLUE}║${CYAN} 📘 Facebook 1: ${WHITE}https://www.facebook.com/s2code08122000/                  ${BLUE}║${NC}"
echo -e "${BLUE}║${CYAN} 📘 Facebook 2: ${WHITE}https://www.facebook.com/tangoclongmeta                   ${BLUE}║${NC}"
echo -e "${BLUE}║${CYAN} 📱 Telegram:   ${WHITE}https://t.me/S2codetaem48                                ${BLUE}║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

echo -e "${PURPLE}🚀 Bắt đầu cài đặt Proxy Server...${NC}"
echo ""
sleep 2

# Hàm kiểm tra IP
check_ip_status() {
    local ip=$1
    echo -e "${YELLOW}🔍 Đang kiểm tra trạng thái IP...${NC}"
    if ping -c 3 $ip > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Hàm lấy thông tin IP
get_ip_info() {
    local ip=$1
    echo -e "${CYAN}📡 Đang lấy thông tin IP...${NC}"
    ip_info=$(curl -s "http://ip-api.com/json/$ip")
    echo "$ip_info"
}

# Hàm kiểm tra tốc độ mạng
check_network_speed() {
    echo -e "${CYAN}⚡ Đang kiểm tra tốc độ mạng...${NC}"
    speed_test=$(curl -s -w "%{speed_download}" -o /dev/null http://speedtest.ftp.otenet.gr/files/test1Mb.db)
    speed_mbps=$(echo "scale=2; $speed_test / 1024 / 1024 * 8" | bc 2>/dev/null || echo "N/A")
    echo "$speed_mbps"
}

# Hàm kiểm tra hỗ trợ protocols
check_proxy_protocols() {
    local ip=$1
    local port=$2
    local user=$3
    local pass=$4
    
    echo -e "${CYAN}🔧 Đang kiểm tra protocols hỗ trợ...${NC}"
    
    # Test HTTP
    http_test=$(curl -s -o /dev/null -w "%{http_code}" --proxy http://$user:$pass@$ip:$port http://httpbin.org/ip --connect-timeout 10)
    
    # Test SOCKS5
    socks5_test=$(curl -s -o /dev/null -w "%{http_code}" --socks5 $user:$pass@$ip:$port http://httpbin.org/ip --connect-timeout 10)
    
    protocols=""
    if [ "$http_test" = "200" ]; then
        protocols="HTTP ✅"
    else
        protocols="HTTP ❌"
    fi
    
    if [ "$socks5_test" = "200" ]; then
        protocols="$protocols, SOCKS5 ✅"
    else
        protocols="$protocols, SOCKS5 ❌"
    fi
    
    echo "$protocols"
}

# Menu đăng nhập
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${WHITE}                              CHỌN LOẠI ĐĂNG NHẬP                              ${GREEN}║${NC}"
echo -e "${GREEN}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${GREEN}║${YELLOW} [1] 👤 Đăng nhập bình thường (Chỉ hiển thị IP cơ bản)                      ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} [2] 💎 Đăng nhập VIP (Đầy đủ tính năng check IP, tốc độ, protocols)      ${GREEN}║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

read -p "➤ Chọn loại đăng nhập (1/2): " login_type

if [ "$login_type" = "1" ]; then
    # Đăng nhập bình thường
    echo -e "${CYAN}👤 ĐĂNG NHẬP BÌNH THƯỜNG${NC}"
    read -p "➤ Nhập tên đăng nhập: " username
    read -p "➤ Nhập mật khẩu: " password
    
    if [ "$username" = "tangoclong" ] && [ "$password" = "6969" ]; then
        echo -e "${GREEN}✅ Đăng nhập thành công!${NC}"
        echo -e "${YELLOW}🔄 Chế độ thủ công - Tạo proxy bền vững...${NC}"
        
        # Cập nhật hệ thống
        echo "[1/7] ➤ Đang cập nhật hệ thống..."
        sudo apt update && sudo apt upgrade -y
        
        # Cài gói cần thiết
        echo "[2/7] ➤ Đang cài Squid + Apache2-utils..."
        sudo apt install -y squid apache2-utils vim curl bc
        
        # Hỏi port proxy
        read -p "[3/7] ➤ Nhập cổng proxy bạn muốn dùng (ví dụ 6969): " proxy_port
        
        # Gỡ file cấu hình cũ
        echo "[4/7] ➤ Gỡ cấu hình cũ của Squid..."
        sudo rm -f /etc/squid/squid.conf
        
        # Tạo cấu hình mới
        echo "[5/7] ➤ Tạo file cấu hình mới cho Squid..."
        cat <<EOF | sudo tee /etc/squid/squid.conf > /dev/null
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
auth_param basic realm proxy
acl authenticated proxy_auth REQUIRED
http_access allow authenticated
http_port $proxy_port
EOF
        
        # Tạo tài khoản proxy
        read -p "[6/7] ➤ Nhập tên người dùng proxy muốn tạo: " squid_user
        read -p "[6/7] ➤ Nhập mật khẩu cho '$squid_user': " squid_pass
        echo "$squid_pass" | sudo htpasswd -c -i /etc/squid/passwords "$squid_user"
        
        # Khởi động lại Squid
        echo "[7/7] ➤ Khởi động lại dịch vụ Squid..."
        sudo systemctl restart squid
        
        # Lấy IP 
        ip_address=$(curl -s ipinfo.io/ip)
        
        echo -e "${GREEN}✅ Cài đặt thành công!${NC}"
        echo -e "${CYAN}🌐 Proxy: ${WHITE}http://$squid_user:$squid_pass@$ip_address:$proxy_port${NC}"
        echo -e "${CYAN}📍 IP: ${WHITE}$ip_address${NC}"
        
    else
        echo -e "${RED}❌ Sai tên đăng nhập hoặc mật khẩu!${NC}"
        exit 1
    fi
    
elif [ "$login_type" = "2" ]; then
    # Đăng nhập VIP
    echo -e "${PURPLE}💎 ĐĂNG NHẬP VIP${NC}"
    read -p "➤ Nhập mã VIP: " vip_code
    
    if [ "$vip_code" = "So1234@@" ]; then
        echo -e "${GREEN}✅ Đăng nhập VIP thành công!${NC}"
        echo -e "${PURPLE}🚀 Chế độ VIP - Tự động cài đặt nhanh...${NC}"
        
        # Tự động cài đặt VIP
        proxy_port="6969"
        squid_user="tangoclong"
        squid_pass="2000"
        
        # Cập nhật hệ thống
        echo "[1/5] ➤ Đang cập nhật hệ thống..."
        sudo apt update && sudo apt upgrade -y
        
        # Cài gói cần thiết
        echo "[2/5] ➤ Đang cài Squid + Apache2-utils..."
        sudo apt install -y squid apache2-utils vim curl bc
        
        # Gỡ file cấu hình cũ
        echo "[3/5] ➤ Gỡ cấu hình cũ của Squid..."
        sudo rm -f /etc/squid/squid.conf
        
        # Tạo cấu hình mới
        echo "[4/5] ➤ Tạo file cấu hình VIP cho Squid..."
        cat <<EOF | sudo tee /etc/squid/squid.conf > /dev/null
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
auth_param basic realm proxy
acl authenticated proxy_auth REQUIRED
http_access allow authenticated
http_port $proxy_port
EOF
        
        # Tạo tài khoản proxy VIP
        echo "[5/5] ➤ Tạo tài khoản VIP..."
        echo "$squid_pass" | sudo htpasswd -c -i /etc/squid/passwords "$squid_user"
        
        # Khởi động lại Squid
        echo "[5/5] ➤ Khởi động lại dịch vụ Squid..."
        sudo systemctl restart squid
        
        # Lấy IP và kiểm tra
        ip_address=$(curl -s ipinfo.io/ip)
        
        if check_ip_status $ip_address; then
            echo -e "${GREEN}✅ Cài đặt VIP thành công!${NC}"
            
            # Lấy thông tin IP
            ip_info=$(get_ip_info $ip_address)
            isp=$(echo $ip_info | grep -o '"isp":"[^"]*"' | cut -d'"' -f4)
            country=$(echo $ip_info | grep -o '"country":"[^"]*"' | cut -d'"' -f4)
            
            # Kiểm tra tốc độ
            speed=$(check_network_speed)
            
            # Kiểm tra protocols
            protocols=$(check_proxy_protocols $ip_address $proxy_port $squid_user $squid_pass)
            
            echo -e "${PURPLE}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
            echo -e "${PURPLE}║${WHITE}                             THÔNG TIN PROXY VIP                              ${PURPLE}║${NC}"
            echo -e "${PURPLE}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
            echo -e "${PURPLE}║${CYAN} 🌐 Proxy URL: ${WHITE}http://tangoclong:2000@$ip_address:6969${PURPLE}║${NC}"
            echo -e "${PURPLE}║${CYAN} 📍 Địa chỉ IP: ${WHITE}$ip_address${PURPLE}║${NC}"
            echo -e "${PURPLE}║${CYAN} 🏢 Nhà mạng: ${WHITE}$isp${PURPLE}║${NC}"
            echo -e "${PURPLE}║${CYAN} 🌍 Quốc gia: ${WHITE}$country${PURPLE}║${NC}"
            echo -e "${PURPLE}║${CYAN} ⚡ Tốc độ mạng: ${WHITE}${speed} Mbps${PURPLE}║${NC}"
            echo -e "${PURPLE}║${CYAN} 🔧 Protocols: ${WHITE}$protocols${PURPLE}║${NC}"
            echo -e "${PURPLE}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
        else
            echo -e "${RED}❌ IP lỗi - Không thể kết nối!${NC}"
        fi
        
    else
        echo -e "${RED}❌ Mã VIP không đúng!${NC}"
        exit 1
    fi
    
else
    echo -e "${RED}❌ Lựa chọn không hợp lệ!${NC}"
    exit 1
fi

# Hiển thị thông tin liên hệ cuối
echo ""
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║${WHITE}                              THÔNG TIN NHÀ PHÁT TRIỂN                        ${GREEN}║${NC}"
echo -e "${GREEN}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${GREEN}║${YELLOW} 👨‍💻 Nhà phát triển: ${WHITE}TẠ NGỌC LONG                                           ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 🌐 Chuyên cung cấp tài khoản Google Cloud số lượng lớn                     ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 🎮 Chuyên cung cấp các mặt hàng MMO                                        ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 🔗 Chuyên cung cấp tài nguyên Proxy, tài khoản các loại                    ${GREEN}║${NC}"
echo -e "${GREEN}║${YELLOW} 💻 Nhận tạo Tools, tạo Web, code phần mềm theo nhu cầu                     ${GREEN}║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║${WHITE}                                LIÊN HỆ                                      ${BLUE}║${NC}"
echo -e "${BLUE}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
echo -e "${BLUE}║${CYAN} 📘 Facebook 1: ${WHITE}https://www.facebook.com/s2code08122000/                  ${BLUE}║${NC}"
echo -e "${BLUE}║${CYAN} 📘 Facebook 2: ${WHITE}https://www.facebook.com/tangoclongmeta                   ${BLUE}║${NC}"
echo -e "${BLUE}║${CYAN} 📱 Telegram:   ${WHITE}https://t.me/S2codetaem48                                ${BLUE}║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

echo -e "${CYAN}🎉 Cảm ơn bạn đã sử dụng dịch vụ của S2CODE TEAM! 🎉${NC}"
echo -e "${YELLOW}💡 Nếu cần hỗ trợ, vui lòng liên hệ qua các kênh trên! 💡${NC}"
